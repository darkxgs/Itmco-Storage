# قائمة المهام المطلوبة

## 1. سعر البيع المخصص في صفحة الإصدارات ✅
**الوصف:** إضافة حقل سعر بيع مخصص لكل إصدار (يختلف عن سعر البيع الأساسي للمنتج)

**التفاصيل:**
- [x] إضافة حقل `customSellingPrice` في نموذج الإصدار (يظهر فقط عند اختيار "بدون ضمان")
- [x] الحقل اختياري - إذا لم يُملأ يستخدم سعر البيع الأساسي من المنتج
- [x] عرض إجمالي السعر (الكمية × سعر البيع) تحت حقل الضمان
- [x] حفظ سعر البيع المخصص في الملاحظات (لأن العمود غير موجود في قاعدة البيانات)
- [x] سعر البيع المخصص لكل منتج على حدة (وليس سعر واحد لكل الإصدار)

**ملاحظة:** السعر يُحفظ في الملاحظات بصيغة "سعر البيع: XXX"

---

## 2. إصلاح البحث في سجل الإصدارات ✅
**المشكلة:** عند كتابة اسم العميل في البحث، تختفي جميع النتائج

**الحل:**
- [x] مراجعة دالة `filteredIssuances` في صفحة الإصدارات
- [x] التأكد من أن البحث يعمل على `customer_name` و `customerName`
- [x] إصلاح منطق الفلترة ليعرض النتائج بشكل صحيح
- [x] إضافة البحث في اسم المنتج أيضاً

---

## 3. إضافة عمود الربح في تقرير Excel ✅
**الوصف:** إضافة عمود "الربح" بعد عمود "سعر البيع" في تقرير Excel

**التفاصيل:**
- [x] إضافة عمود "الربح" = سعر البيع - سعر الشراء
- [x] حساب الربح تلقائياً في التصدير
- [x] الترتيب: سعر الشراء → سعر البيع → الربح
- [x] إضافة عمود "الإجمالي" (رقم فقط بدون نص)

---

## 4. إصلاح تعديل كود الصنف في إدارة المخزون ✅
**المشكلة:** زر "حفظ التعديلات" يختفي بسرعة عند تعديل كود الصنف

**الحل:**
- [x] جعل التعديل مباشر في الجدول (inline editing)
- [x] حفظ التعديلات تلقائياً عند الخروج من الحقل (onBlur) أو الضغط على Enter
- [x] إمكانية الإلغاء بالضغط على Escape
- [x] النقر على كود الصنف يفتح حقل التعديل مباشرة

---

## 5. إصلاح أخطاء TypeScript في صفحة المخزون ✅
**المشكلة:** 117 خطأ TypeScript في app/inventory/page.tsx

**الحل:**
- [x] إضافة نوع `Product[]` للـ products state
- [x] إصلاح `minStock` → `min_stock` (اسم العمود في قاعدة البيانات)
- [x] إصلاح معاملات دوال `updateProduct` و `deleteProduct`
- [x] إضافة فحص null للـ user
- [x] تحويل `warehouse_id` من string إلى number
- [x] إصلاح مشكلة `dataValidations` في ExcelJS

---

## 6. إصلاح بند العهدة في الإصدارات ✅
**المشكلة:** بند العهدة لا يعمل عند إصدار قطع غيار

**الحل:**
- [x] إضافة validation للتأكد من اختيار نوع الضمان قبل الإرسال
- [x] العهدة (custody) تعمل بشكل صحيح - يتم حفظ `warranty_type: 'custody'`

---

## 7. استيراد الفروع من Excel ✅
**الوصف:** إضافة ميزة استيراد الفروع من ملف Excel في صفحة إدارة الفروع

**التفاصيل:**
- [x] زر "تحميل القالب" لتحميل ملف Excel نموذجي
- [x] زر "استيراد من Excel" لرفع ملف Excel
- [x] معاينة البيانات قبل الاستيراد
- [x] ربط الفرع بالعميل تلقائياً إذا كان اسم العميل موجوداً
- [x] دعم الأعمدة: اسم الفرع، كود الفرع، العنوان، الهاتف، المدير، العميل

---

## حالة التنفيذ:
| المهمة | الحالة |
|--------|--------|
| سعر البيع المخصص | ✅ مكتمل |
| إصلاح البحث | ✅ مكتمل |
| عمود الربح في Excel | ✅ مكتمل |
| إصلاح تعديل كود الصنف | ✅ مكتمل |
| إصلاح أخطاء TypeScript | ✅ مكتمل |
| إصلاح بند العهدة | ✅ مكتمل |
| استيراد الفروع من Excel | ✅ مكتمل |

---

## ملخص التغييرات:

### 1. سعر البيع المخصص (app/issuance/page.tsx)
- إضافة state: `customSellingPrice`
- حقل إدخال يظهر فقط عند "بدون ضمان"
- عرض إجمالي السعر في صندوق أخضر
- حفظ السعر في الملاحظات
- سعر مخصص لكل منتج على حدة

### 2. إصلاح البحث (app/issuance/page.tsx)
- تحسين منطق `filteredIssuances`
- البحث في: اسم العميل، المهندس، السريال، اسم المنتج
- معالجة الحالات الفارغة

### 3. عمود الربح (lib/export-utils.ts)
- إضافة "الربح" في TABLE_HEADERS
- حساب: الربح = سعر البيع - سعر الشراء
- إضافة في mapRowForStrings و tableData
- إضافة عمود "الإجمالي"

### 4. تعديل كود الصنف (app/inventory/page.tsx)
- states: `editingItemCodeId`, `editingItemCodeValue`
- دالة `handleSaveItemCode`
- تعديل مباشر بالنقر على الكود
- حفظ: onBlur أو Enter | إلغاء: Escape

### 5. إصلاح بند العهدة (app/issuance/page.tsx)
- إضافة validation للتأكد من اختيار نوع الضمان
- رسالة خطأ واضحة إذا لم يتم اختيار نوع الضمان

### 6. استيراد الفروع من Excel (app/branches/page.tsx)
- إضافة imports: useRef, XLSX, Upload, FileSpreadsheet, Download
- states: importDialogOpen, importing, importPreview, fileInputRef
- دوال: handleFileSelect, handleImportBranches, downloadTemplate
- UI: أزرار تحميل القالب واستيراد من Excel
- Dialog لمعاينة البيانات قبل الاستيراد
